<!DOCTYPE html>
<html lang="en">
<head>
{% load static %}
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mentoring Reports | Admin</title>

<link rel="stylesheet" href="{% static 'styles/admin.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ================= LAYOUT ================= */
.report-wrapper{
  background:#f4f6f8;
  padding:30px;
  border-radius:18px
}

/* ================= HEADER ================= */
.report-header{text-align:center;margin-bottom:25px}
.report-header h1{
  font-size:26px;
  font-weight:800;
  color:#1c7c31
}
.report-header p{color:#64748b}

/* ================= TABS ================= */
.report-tabs{
  display:flex;
  gap:15px;
  margin-bottom:20px
}
.tab{
  flex:1;
  padding:14px;
  border-radius:14px;
  border:2px solid #e5e7eb;
  background:#fff;
  font-weight:700;
  cursor:pointer;
  text-align:center
}
.tab.active{
  background:#28a745;
  color:#fff;
  border-color:#28a745
}

/* ================= FILTER ================= */
.filter-bar{
  background:#fff;
  padding:22px;
  border-radius:16px;
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:20px;
  box-shadow:0 6px 20px rgba(0,0,0,.1)
}
.filter-bar input,
.filter-bar select{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #cbd5e1
}

/* ================= AUTOCOMPLETE ================= */
.suggestions{
  background:#fff;
  border-radius:10px;
  box-shadow:0 6px 18px rgba(0,0,0,.15);
  position:absolute;
  z-index:99;
  width:100%
}
.suggestions div{
  padding:10px 14px;
  cursor:pointer
}
.suggestions div:hover{
  background:#f0fdf4
}

/* ================= REPORT ================= */
.report-sheet{
  margin-top:30px;
  background:#fff;
  padding:60px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
  position:relative;
  min-height:900px
}
.report-sheet::before{
  content:"";
  position:absolute;
  inset:0;
  background:url("{% static 'Assets/logo.png' %}") center no-repeat;
  background-size:420px;
  opacity:.05
}

.report-title{
  text-align:center;
  font-size:22px;
  font-weight:800;
  margin-bottom:20px
}

/* ================= META ================= */
.report-meta{
  margin-top:25px;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:20px
}
.meta-box{
  background:#f6fff6;
  padding:14px;
  border-left:4px solid #28a745;
  border-radius:8px
}
.meta-box label{
  font-size:13px;
  color:#64748b
}
.meta-box span{
  font-weight:700
}

/* ================= KPI ================= */
.kpi-grid{
  margin-top:30px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:20px
}
.kpi{
  background:#fff;
  padding:18px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  text-align:center
}
.kpi h2{
  color:#28a745;
  font-size:30px
}
.kpi p{
  font-size:13px;
  color:#64748b
}

/* ================= TABLE ================= */
.report-table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px
}
.report-table th,
.report-table td{
  border:1px solid #e5e7eb;
  padding:12px;
  font-size:14px
}
.report-table th{
  background:#f0fdf4;
  font-weight:700;
  color:#166534
}

/* ================= TEXT ================= */
.report-text{
  margin-top:10px;
  font-size:14px;
  line-height:1.7;
  color:#374151
}

/* ================= FOOTER ================= */
.report-footer{
  margin-top:60px;
  display:flex;
  justify-content:space-between;
  font-size:12px;
  color:#64748b
}
</style>
</head>

<body>

<header class="header">
  <div class="header-left">
    <img src="{% static 'Assets/logo.png' %}" class="header-logo">
    <div>
      <h2 class="rcss-title">RCSS</h2>
      <p class="rcss-subtitle">RAJAGIRI COLLEGE OF SOCIAL SCIENCES (AUTONOMOUS)</p>
    </div>
  </div>
  <h1 class="main-title">MENTOR MENTEE</h1>
  <div class="header-right">
    <h3>{{ admin.name }}</h3>
    <button class="logout-btn" onclick="location.href='{% url 'logout' %}'">Logout</button>
  </div>
</header>

<div class="container">
<aside class="sidebar">
    <nav class="menu">

      <a class="menu-item" href="/admin_dashboard">
        <i class="fas fa-th-large"></i><span>Dashboard</span>
      </a>
      <hr class="menu-divider">

      <a class="menu-item" href="/admin_viewFaculty">
        <i class="fas fa-user"></i><span>View Faculty</span>
      </a>

      <hr class="menu-divider">

      <div class="dropdown">
        <a class="menu-item dropdown-toggle">
          <i class="fas fa-graduation-cap"></i><span>Students</span>
          <i class="fas fa-chevron-down dropdown-icon"></i>
        </a>
        <div class="dropdown-menu">
          <a class="dropdown-item" href="/admin_addStudent"><i class="fas fa-user-plus"></i>Add Student</a>
          <a class="dropdown-item" href="/admin_ViewStudents"><i class="fas fa-users"></i>View Students</a>
        </div>
      </div>
      <hr class="menu-divider">

            <div class="dropdown">
                <a class="menu-item dropdown-toggle">
                    <i class="fas fa-book"></i><span>Batches</span>
                    <i class="fas fa-chevron-down dropdown-icon"></i>
                </a>
                <div class="dropdown-menu">
                    <a class="dropdown-item active" href="/admin_addBatch"><i class="fas fa-plus"></i>Create Batch</a>
                    <a class="dropdown-item" href="/admin_viewBatches"><i class="fas fa-layer-group"></i>View Batches</a>
                </div>
            </div>

      <hr class="menu-divider">

      <div class="dropdown">
        <a class="menu-item dropdown-toggle">
          <i class="fas fa-link"></i><span>Assignments</span>
          <i class="fas fa-chevron-down dropdown-icon"></i>
        </a>
        <div class="dropdown-menu">
          <a class="dropdown-item" href="/admin_AddAssignment"><i class="fas fa-user-plus"></i>Assign Student</a>
          <a class="dropdown-item" href="/admin_ViewAssignments"><i class="fas fa-users"></i>View Assignments</a>
        </div>
      </div>

      <hr class="menu-divider">

      <div class="dropdown">
        <a class="menu-item dropdown-toggle">
          <i class="fas fa-link"></i><span>Mentoring Sessions</span>
          <i class="fas fa-chevron-down dropdown-icon"></i>
        </a>
        <div class="dropdown-menu">
          <a class="dropdown-item" href="/admin_createSession"><i class="fas fa-user-plus"></i>Create Session</a>
          <a class="dropdown-item" href="/admin_viewSessions"><i class="fas fa-users"></i>View Sessions</a>
        </div>
      </div>

      <hr class="menu-divider">

      <a class="menu-item active" href="/admin_reports">
        <i class="fas fa-user"></i><span>Report</span>
      </a>

      <hr class="menu-divider">

      <a class="menu-item" href="/admin_profile">
        <i class="fas fa-user"></i><span>Profile</span>
      </a>

    </nav>
  </aside>

<main class="main-content">
<div class="report-wrapper">

<div class="report-header">
  <h1>Mentoring Reports</h1>
  <p>Search → Preview → Download</p>
  <div style="text-align:right;margin-top:10px">
  <button class="tab"
          style="max-width:220px"
          onclick="downloadPDF()">
    <i class="fas fa-file-pdf"></i> Download PDF
  </button>
</div>

</div>

<div class="report-tabs">
  <div class="tab active" onclick="setType('student',this)">Student</div>
  <div class="tab" onclick="setType('faculty',this)">Faculty</div>
  <div class="tab" onclick="setType('batch',this)">Batch</div>
</div>

<div class="filter-bar">
  <div style="position:relative">
    <label>Search</label>
    <input id="search" placeholder="Type name..." onkeyup="searchEntity()">
    <div id="suggestions" class="suggestions"></div>
  </div>

  <div>
    <label>Time Period</label>
    <select id="range" onchange="if(selectedId!==null) loadReport()">
      <option value="monthly">This Month</option>
      <option value="daily">Today</option>
    </select>
  </div>
</div>

<div class="report-sheet" id="reportSheet">
  <h2 class="report-title">MENTORING PROGRAMME REPORT</h2>
  <p style="text-align:center;color:#64748b">
    Select Student / Faculty / Batch to generate report
  </p>
</div>

</div>
</main>
</div>

<script>
let reportType="student", selectedId=null;

function setType(t,el){
  reportType=t;
  selectedId=null;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  el.classList.add('active');
  search.value="";
  suggestions.innerHTML="";
  reportSheet.innerHTML=`
    <h2 class="report-title">MENTORING PROGRAMME REPORT</h2>
    <p style="text-align:center;color:#64748b">
      Select ${t} to generate report
    </p>`;
}


function searchEntity(){
  const q=search.value;
  if(q.length<2) return;
  fetch(`/api/search_entities/?mode=${reportType}&q=${q}`)
    .then(r=>r.json())
    .then(d=>{
      suggestions.innerHTML="";
      d.results.forEach(x=>{
        const div=document.createElement("div");
        div.innerText=x.label;
        div.onclick = () => {
  selectedId = parseInt(x.id);   // ✅ ensure number
  search.value = x.label;
  suggestions.innerHTML = "";

  // ✅ defer execution to next event loop
  setTimeout(() => {
    loadReport();
  }, 0);
};
        suggestions.appendChild(div);
      });
    });
}

function loadReport(){
  if(selectedId===null) return;

  fetch(`/api/report_data/?type=${reportType}&id=${selectedId}&range=${range.value}`)
    .then(r=>r.json())
    .then(d=>{
      reportSheet.innerHTML=`
      <h2 class="report-title">MENTORING PROGRAMME REPORT</h2>

      <div class="report-meta">
        <div class="meta-box"><label>Category</label><span>${reportType.toUpperCase()}</span></div>
        <div class="meta-box"><label>Period</label><span>${d.period_label}</span></div>
        <div class="meta-box"><label>Generated</label><span>${new Date().toLocaleDateString()}</span></div>
      </div>

      <h3 style="margin-top:35px">Executive Summary</h3>
      <p class="report-text">
        During the selected period, the mentoring programme recorded
        <b>${d.current.total_sessions}</b> sessions compared to
        <b>${d.previous.total_sessions}</b> in the previous period,
        indicating a <b>${d.comparison.session_change}%</b>
        ${d.comparison.session_trend}.
      </p>

      <div class="kpi-grid">
        <div class="kpi"><h2>${d.current.total_sessions}</h2><p>Sessions</p></div>
        <div class="kpi"><h2>${d.current.students}</h2><p>Students</p></div>
        <div class="kpi"><h2>${d.current.faculty}</h2><p>Faculty</p></div>
        <div class="kpi"><h2>${d.current.avg_sessions}</h2><p>Avg / Student</p></div>
      </div>

      <h3 style="margin-top:40px">Comparative Analysis</h3>

      <table class="report-table">
        <tr>
          <th>Metric</th>
          <th>Previous</th>
          <th>Current</th>
          <th>Change</th>
        </tr>
        <tr>
          <td>Total Sessions</td>
          <td>${d.previous.total_sessions}</td>
          <td>${d.current.total_sessions}</td>
          <td>${d.comparison.session_change}%</td>
        </tr>
        <tr>
          <td>Students Covered</td>
          <td>${d.previous.students}</td>
          <td>${d.current.students}</td>
          <td>${d.comparison.student_change}%</td>
        </tr>
      </table>

      <h3 style="margin-top:40px">Observations</h3>
      <p class="report-text">
        The mentoring engagement shows a
        <b>${d.comparison.session_trend}</b> trend.
        Continuous mentoring activities are recommended to sustain
        student development and faculty involvement.
      </p>

      <div class="report-footer">
        <span>Generated by Mentor–Mentee System</span>
        <span>Authorized by {{ admin.name }}</span>
      </div>
      `;
    });
}
document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
        toggle.addEventListener('click', function (e) {
      e.preventDefault();
      const dropdown = this.closest('.dropdown');
      dropdown.classList.toggle('open');
    });
  });

  function downloadPDF(){
  if(!selectedId) return alert("Generate report first");
  window.open(`/admin_report_pdf/?type=${reportType}&id=${selectedId}&range=${range.value}`);
}
</script>

</body>
</html>
