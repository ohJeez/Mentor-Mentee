<!DOCTYPE html>
<html lang="en">
<head>
{% load static %}
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Profile | Mentor Mentee</title>

<link rel="stylesheet" href="{% static 'styles/admin.css' %}">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>
/* ---------- COLORS ---------- */
:root{
  --green:#28a745;
  --green-dark:#218838;
  --light:#dff5e1;
}

/* ---------- PROFILE ---------- */
.profile-container{display:flex;justify-content:center;margin-top:30px}
.profile-card{
  width:80%;background:#fff;padding:30px;border-radius:18px;
  box-shadow:0 6px 20px rgba(0,0,0,.1)
}
.profile-header{display:flex;gap:25px;align-items:center}
.student-photo{
  width:120px;height:120px;border-radius:50%;
  object-fit:cover;border:4px solid var(--green)
}

.details-grid{
  display:grid;grid-template-columns:repeat(2,1fr);
  gap:18px;margin-top:25px
}
.detail-box{
  background:var(--light);
  padding:14px;border-left:4px solid var(--green);
  border-radius:10px
}
.detail-title{font-size:13px;color:#166534;font-weight:600}
.detail-value{font-size:16px;font-weight:600}

.edit-btn{
  background:var(--green);color:#fff;
  padding:12px 22px;border-radius:8px;
  font-weight:600;border:none;cursor:pointer;
  margin-top:25px
}

/* ---------- MODAL ---------- */
/* ================= MODAL (PROFESSIONAL) ================= */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  backdrop-filter: blur(3px);
  justify-content:center;
  align-items:center;
  z-index:999;
}

.modal-content{
  width:440px;
  background:#fff;
  border-radius:18px;
  padding:30px 32px;
  box-shadow:0 20px 60px rgba(0,0,0,.25);
  animation: modalFade .35s ease;
}

@keyframes modalFade{
  from{opacity:0;transform:translateY(20px) scale(.98)}
  to{opacity:1;transform:translateY(0) scale(1)}
}

.modal-header{
  display:flex;
  align-items:center;
  gap:12px;
  font-size:20px;
  font-weight:800;
  color:var(--green);
  margin-bottom:18px;
}

.modal-header i{
  font-size:22px;
}

.modal-body label{
  display:block;
  margin-top:14px;
  font-size:13px;
  font-weight:600;
  color:#374151;
}

.modal-body input[type="email"],
.modal-body input[type="text"],
.modal-body input[type="date"]{
  width:100%;
  padding:12px 14px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-size:14px;
  transition:.2s;
}

.modal-body input:focus{
  outline:none;
  border-color:var(--green);
  box-shadow:0 0 0 3px rgba(40,167,69,.15);
}

/* ---------- IMAGE UPLOAD ---------- */
.image-upload{
  margin-top:15px;
  display:flex;
  align-items:center;
  gap:18px;
}

.preview-img{
  width:90px;
  height:90px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid var(--green);
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}

.file-box{
  flex:1;
}

.file-box input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px dashed var(--green);
  cursor:pointer;
  background:#f0fdf4;
}

/* ---------- ACTIONS ---------- */
.modal-actions{
  margin-top:25px;
  display:flex;
  justify-content:flex-end;
  gap:12px;
}

.modal-actions button{
  padding:10px 18px;
  border-radius:10px;
  font-weight:600;
  font-size:14px;
  cursor:pointer;
  border:none;
}

/* ===== PASSWORD INPUT UI ===== */
.input-group {
  margin-top: 14px;
}

.input-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 6px;
}

.input-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
  background: #f9fafb;
  border: 1px solid #d1d5db;
  border-radius: 12px;
  padding: 12px 14px;
  transition: 0.25s ease;
}

.input-wrapper i {
  color: #6b7280;
  font-size: 15px;
}

/* ===== PASSWORD INPUT WITH EYE ===== */
.input-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
  background: #f9fafb;
  border: 1px solid #d1d5db;
  border-radius: 12px;
  padding: 12px 14px;
  transition: 0.25s ease;
}

.input-wrapper i {
  color: #6b7280;
  font-size: 15px;
}

.input-wrapper input {
  border: none;
  outline: none;
  background: transparent;
  width: 100%;
  font-size: 14px;
  font-weight: 500;
  color: #111827;
}

/* .input-wrapper:focus-within {
  border-color: var(--green);
  box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.15);
  background: #ffffff;
} */

/* .input-wrapper:focus-within i {
  color: var(--green);
} */

.toggle-eye {
  cursor: pointer;
  transition: 0.2s ease;
}

.toggle-eye:hover {
  color: var(--green);
}

.input-wrapper input {
  border: none;
  outline: none;
  background: transparent;
  width: 100%;
  font-size: 14px;
  font-weight: 500;
  color: #111827;
}

.modal input:focus {
  outline: none !important;
  box-shadow: none !important;
  border-color: var(--green) !important; /* keep clean border */
}
/* .input-wrapper:focus-within {
  border-color: var(--green);
  box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.15);
  background: #ffffff;
} */
/* 
.input-wrapper:focus-within i {
  color: var(--green);
} */

.otp-box{
  width:45px;
  height:45px;
  font-size:18px;
  text-align:center;
  border-radius:10px;
  border:1px solid #d1d5db;
}
.otp-box:focus{
  border-color:var(--green);
  outline:none;
}

.cancel-btn{
  background:#e5e7eb;
  color:#374151;
}

.cancel-btn:hover{
  background:#d1d5db;
}

.save-btn{
  background:var(--green);
  color:#fff;
}

.save-btn:hover{
  background:var(--green-dark);
}

</style>
</head>

<body>

<!-- HEADER --> <header class="header"> 
    <div class="header-left"> <img src="{% static '../static/Assets/logo.png' %}" class="header-logo"> 
        <div class="header-title"> 
            <h2 class="rcss-title">RCSS</h2> 
            <p class="rcss-subtitle">RAJAGIRI COLLEGE OF SOCIAL SCIENCES (AUTONOMOUS)</p>
         </div> 
        </div> 
        <h1 class="main-title">MENTOR MENTEE</h1> 
        <div class="header-right"> <h3>{{student.name}}</h3> 
          {% if student.student_image %}
            <div class="user-profile-icon"><img src="{{ student.student_image.url }}" alt="Student">
              {% else %}
            <div class="user-profile-icon"><i class="fas fa-user-circle"></i></div>
            {% endif %}
            </div> 
            <button onclick="window.location.href='{% url 'logout' %}'" class="logout-btn">Logout</button>
 </div>
 </header>

<div class="container">
    <aside class="sidebar">
            <nav class="menu">

                <a class="menu-item" href="/student_dashboard">
                    <i class="fas fa-th-large"></i><span>Dashboard</span>
                </a>
                <hr class="menu-divider">

                <a class="menu-item" href="/student_uploads">
                    <i class="fas fa-folder-open"></i><span>My Uploads</span>
                </a>

                <hr class="menu-divider">

                <a class="menu-item" href="/student_viewSessions">
                    <i class="fas fa-file-alt"></i><span>My Sessions</span>
                </a>

                <hr class="menu-divider">

                <a class="menu-item" href="/student_RequestSession">
                    <i class="fas fa-calendar-plus"></i><span>Request Session</span>
                </a>

                <hr class="menu-divider">

                <a class="menu-item active" href="/student_profile">
                    <i class="fas fa-user"></i><span>Profile</span>
                </a>

            </nav>
        </aside>
<main class="main-content">

<div class="profile-container">
<div class="profile-card">

  <div class="profile-header">
    {% if student.student_image %}
    <img src="{{student.student_image.url}}" class="student-photo" id="profileImg">
    {% else %}
    <img src="{% static 'Assets/default_profile.png' %}" class="student-photo" id="profileImg">
    {% endif %}
    <div>
      <h2>{{ student.name }}</h2>
      <p>Reg No: <strong>{{ student.reg_no }}</strong></p>
    </div>
  </div>

  <div class="details-grid">
    <div class="detail-box"><p class="detail-title">Email</p><p class="detail-value">{{ student.email }}</p></div>
    <div class="detail-box"><p class="detail-title">Phone</p><p class="detail-value">{{ student.phone }}</p></div>
    <div class="detail-box"><p class="detail-title">Batch</p><p class="detail-value">{{ student.batch.batch_name }}</p></div>
    <div class="detail-box"><p class="detail-title">Mentor</p>
      <p class="detail-value">{{ student.faculty.name|default:"Unassigned" }}</p>
    </div>
  </div>

  <button class="edit-btn" onclick="openModal()">
    <i class="fas fa-edit"></i> Edit Profile
  </button>
  <button class="edit-btn" style="margin-left:12px;background:#0d6efd"
        onclick="openPasswordModal()">
    <i class="fas fa-shield-alt"></i> Change Password
  </button>


</div>
</div>

</main>
</div>

<!-- ================= MODAL ================= -->
<!-- ================= EDIT PROFILE MODAL ================= -->
<div class="modal" id="editModal">
  <div class="modal-content">

    <div class="modal-header">
      <i class="fas fa-user-edit"></i>
      Edit Profile
    </div>

    <form method="POST" action="{% url 'student_update_profile' %}" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="modal-body">

        <label>Profile Picture</label>
        <div class="image-upload">
          {% if student.student_image %}
          <img id="preview" class="preview-img"
               src="{{ student.student_image.url }}">
          {% else %}
          <img id="preview" class="preview-img"
               src="{% static 'Assets/default_profile.png' %}">
          {% endif %}
          <div class="file-box">
            <input type="file" name="student_image" accept="image/*"
                   onchange="previewImage(this)">
          </div>
        </div>

        <label>Email</label>
        <input type="email" name="email" value="{{ student.email }}" required>

        <label>Phone</label>
        <input type="text" name="phone" value="{{ student.phone }}" required>

        <label>Date of Birth</label>
        <input type="date" name="dob" value="{{ student.dob|date:'Y-m-d' }}">

      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
        <button type="submit" class="save-btn">Save Changes</button>
      </div>

    </form>
  </div>
</div>

<!-- ===============Current Password Modal================== -->
 <div class="modal" id="passwordModal">
  <div class="modal-content">
    <div class="modal-header">
      <i class="fas fa-lock"></i> Verify Password
    </div>

    <div class="modal-body">

  <label>Current Password</label>

  <div class="input-wrapper">
    <i class="fas fa-lock"></i>
    <input type="password"
           id="currentPassword"
           placeholder="Enter current password">
          <i class="fas fa-eye toggle-eye"
            onclick="togglePassword(this, 'currentPassword')"></i>
        </div>

        <p style="margin-top:14px;font-size:13px;color:#0d6efd;cursor:pointer"
          onclick="openForgotModal()">
          Forgot password?
        </p>

      </div>


    <div class="modal-actions">
      <button class="cancel-btn" onclick="closePasswordModal()">Cancel</button>
      <button class="save-btn" onclick="verifyPassword()">Continue</button>
    </div>
  </div>
</div>


<!-- ===========================New Password Modal======================== -->
 <div class="modal" id="newPasswordModal">
  <div class="modal-content">
    <div class="modal-header">
      <i class="fas fa-key"></i> Set New Password
    </div>
   <div class="modal-body">

      <div class="input-group">
        <label>New Password</label>
        <div class="input-wrapper">
    <i class="fas fa-lock"></i>
    <input type="password"
           id="newPassword"
           placeholder="Enter New password">
          <i class="fas fa-eye toggle-eye"
            onclick="togglePassword(this, 'newPassword')"></i>
        </div>
      </div>

      <div class="input-group">
        <label>Confirm Password</label>
        <div class="input-wrapper">
    <i class="fas fa-lock"></i>
    <input type="password"
           id="confirmPassword"
           placeholder="Enter current password">
          <i class="fas fa-eye toggle-eye"
            onclick="togglePassword(this, 'confirmPassword')"></i>
        </div>
      </div>

    </div>

    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeNewPasswordModal()">Cancel</button>
      <button class="save-btn" onclick="saveNewPassword()">Save</button>
    </div>
  </div>
</div>

<!-- Send OTP Modal -->
 <div class="modal" id="forgotModal">
  <div class="modal-content">

    <div class="modal-header">
      <i class="fas fa-envelope"></i> Forgot Password
    </div>

    <div class="modal-body">
      <p style="font-size:14px;line-height:1.6">
        An OTP will be sent to your registered email address:
        <br><br>
        <strong>{{ student.email }}</strong>
      </p>
    </div>

    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeForgotModal()">Cancel</button>
      <button class="save-btn" onclick="sendOTP()">Send OTP</button>
    </div>

  </div>
</div>

<div class="modal" id="otpVerifyModal">
  <div class="modal-content">

    <div class="modal-header">
      <i class="fas fa-key"></i> OTP Verification
    </div>

    <div class="modal-body">

      <p style="font-size:14px">
        Enter the 4-digit OTP sent to <strong>{{ student.email }}</strong>
      </p>

      <div style="display:flex;gap:10px;margin-top:15px">
        <input class="otp-box" maxlength="1" inputmode="numeric">
        <input class="otp-box" maxlength="1" inputmode="numeric">
        <input class="otp-box" maxlength="1" inputmode="numeric">
        <input class="otp-box" maxlength="1" inputmode="numeric">
      </div>

    </div>

    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeOTPVerifyModal()">Cancel</button>
      <button class="save-btn" onclick="verifyOTP()">Verify</button>
    </div>

  </div>
</div>



<!-- ====================================OTP Modal============================= -->
 <div class="modal" id="forgotModal">
  <div class="modal-content">
    <div class="modal-header">
      <i class="fas fa-envelope"></i> OTP Verification
    </div>

    <div class="modal-body">
      <p style="font-size:14px">
        Enter the OTP sent to <strong>{{ student.email }}</strong>
      </p>

      <div style="display:flex;gap:10px;margin-top:15px">
      <input class="otp-box" maxlength="1" inputmode="numeric">
      <input class="otp-box" maxlength="1" inputmode="numeric">
      <input class="otp-box" maxlength="1" inputmode="numeric">
      <input class="otp-box" maxlength="1" inputmode="numeric">
    </div>

    </div>

    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeForgotModal()">Cancel</button>
      <button class="save-btn" onclick="verifyOTP()">Verify</button>
    </div>
  </div>
</div>




<script>
/* =========================
   EDIT PROFILE MODAL
========================= */
function openModal() {
  document.getElementById("editModal").style.display = "flex";
}
function closeModal() {
  document.getElementById("editModal").style.display = "none";
}

/* =========================
   IMAGE PREVIEW
========================= */
function previewImage(input) {
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById("preview").src = e.target.result;
  };
  reader.readAsDataURL(file);
}

/* =========================
   PASSWORD VISIBILITY TOGGLE
========================= */
function togglePassword(icon, inputId) {
  const input = document.getElementById(inputId);

  if (input.type === "password") {
    input.type = "text";
    icon.classList.replace("fa-eye", "fa-eye-slash");
  } else {
    input.type = "password";
    icon.classList.replace("fa-eye-slash", "fa-eye");
  }
}

/* =========================
   PASSWORD VERIFY MODAL
========================= */
function openPasswordModal() {
  document.getElementById("passwordModal").style.display = "flex";
}
function closePasswordModal() {
  document.getElementById("passwordModal").style.display = "none";
}

/* =========================
   VERIFY CURRENT PASSWORD
========================= */
function verifyPassword() {
  const input = document.getElementById("currentPassword");
  const password = input.value.trim();

  if (!password) {
    Swal.fire({
      icon: "warning",
      title: "Missing Password",
      text: "Please enter your current password",
      confirmButtonColor: "#28a745"
    });
    return;
  }

  fetch("/verify-current-password/", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({ password })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      closePasswordModal();
      openNewPasswordModal();
    } else {
      Swal.fire({
        icon: "error",
        title: "Incorrect Password",
        text: "The password you entered is incorrect.",
        confirmButtonColor: "#28a745",
        allowOutsideClick: false
      }).then(() => {
        input.value = "";
        input.focus();
      });
    }
  })
  .catch(() => {
    Swal.fire({
      icon: "error",
      title: "Server Error",
      text: "Please try again later.",
      confirmButtonColor: "#28a745"
    });
  });
}

/* =========================
   FORGOT PASSWORD â†’ SEND OTP
========================= */
function openForgotModal() {
  closePasswordModal();
  document.getElementById("forgotModal").style.display = "flex";
}
function closeForgotModal() {
  document.getElementById("forgotModal").style.display = "none";
}

function sendOTP() {
  fetch("/send_otp/", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}"
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "sent") {
      closeForgotModal();
      document.getElementById("otpVerifyModal").style.display = "flex";
      clearOTPInputs();
    }
  });
}

/* =========================
   OTP VERIFICATION
========================= */
function verifyOTP() {
  const boxes = document.querySelectorAll(".otp-box");
  let otp = "";

  boxes.forEach(box => otp += box.value);

  if (!/^\d{4}$/.test(otp)) {
    Swal.fire({
      icon: "error",
      title: "Invalid OTP",
      text: "Please enter the 4-digit OTP.",
      confirmButtonColor: "#dc3545"
    });
    return;
  }

  fetch("/verify_otp/", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ otp })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      document.getElementById("otpVerifyModal").style.display = "none";
      openNewPasswordModal();
    } else {
      Swal.fire({
        icon: "error",
        title: "Wrong OTP",
        text: "The OTP you entered is incorrect.",
        confirmButtonColor: "#dc3545"
      });
      clearOTPInputs();
    }
  });
}

/* =========================
   OTP AUTO FOCUS & SUBMIT
========================= */
const otpInputs = document.querySelectorAll(".otp-box");

function clearOTPInputs() {
  otpInputs.forEach(i => i.value = "");
  otpInputs[0]?.focus();
}

otpInputs.forEach((input, index) => {
  input.addEventListener("input", () => {
    if (input.value && index < otpInputs.length - 1) {
      otpInputs[index + 1].focus();
    }
    if (index === otpInputs.length - 1 && input.value) {
      verifyOTP();
    }
  });

  input.addEventListener("keydown", e => {
    if (e.key === "Backspace" && !input.value && index > 0) {
      otpInputs[index - 1].focus();
    }
  });
});

/* =========================
   NEW PASSWORD MODAL
========================= */
function openNewPasswordModal() {
  document.getElementById("newPasswordModal").style.display = "flex";
}
function closeNewPasswordModal() {
  document.getElementById("newPasswordModal").style.display = "none";
}

/* =========================
   SAVE NEW PASSWORD
========================= */
function saveNewPassword() {
  const p1 = document.getElementById("newPassword").value;
  const p2 = document.getElementById("confirmPassword").value;

  if (p1 !== p2) {
    Swal.fire({
      icon: "error",
      title: "Password Mismatch",
      text: "Passwords do not match",
      confirmButtonColor: "#dc3545"
    });
    return;
  }

  fetch("/update_password/", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ password: p1 })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      Swal.fire({
        icon: "success",
        title: "Password Updated",
        text: "Your password has been updated successfully!",
        confirmButtonColor: "#28a745",
        allowOutsideClick: false
      }).then(() => {
        window.location.href = "/student_profile";
      });
    }
  });
}

function closePasswordModal() {
  document.getElementById("passwordModal").style.display = "none";
}

function closeForgotModal() {
  document.getElementById("forgotModal").style.display = "none";
}

function closeOTPVerifyModal() {
  document.getElementById("otpVerifyModal").style.display = "none";
}

function closeNewPasswordModal() {
  document.getElementById("newPasswordModal").style.display = "none";
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}
</script>


</body>
</html>
