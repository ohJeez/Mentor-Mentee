{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Super Admin | Batches</title>

    <link rel="stylesheet" href="{% static 'styles/admin.css' %}">

    <style>
        body {
            background:#f4f7fb;
            font-family: Poppins, sans-serif;
        }

        .content-wrapper {
            margin-left: 320px;              /* space for sidebar */
            padding: 40px;
            width: calc(100% - 320px);
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 25px;
        }

        .filters-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
        }

        .select-input {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #ccc;
            min-width: 210px;
            font-size: 14px;
        }

        .primary-btn {
            background:#1e9b48;
            color:white;
            border:none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor:pointer;
            font-weight:600;
            display:flex;
            align-items:center;
            gap:6px;
            transition:0.2s;
        }
        .primary-btn:hover {
            background:#157a39;
        }

        .table-card {
            background:white;
            border-radius: 12px;
            padding: 0;
            box-shadow:0 3px 10px rgba(0,0,0,0.06);
            overflow:hidden;
            max-width: 950px;
        }

        table {
            width:100%;
            border-collapse: collapse;
        }

        thead th {
            background:#199644;
            color:white;
            text-align:left;
            padding: 12px 18px;
            font-size:14px;
        }

        tbody td {
            padding: 12px 18px;
            border-bottom:1px solid #f0f0f0;
            font-size:14px;
        }

        tbody tr:nth-child(even){
            background:#fafafa;
        }

        .action-link {
            font-weight:600;
            cursor:pointer;
            margin-right:8px;
        }
        .action-edit {
            color:#007bff;
        }
        .action-delete {
            color:#d9534f;
        }

        /* ---------- Popup ---------- */
        .popup-overlay {
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.35);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:50;
        }
        .popup-overlay.show {
            display:flex;
        }

        .popup-card {
            background:white;
            padding:24px 28px;
            border-radius:12px;
            width:420px;
            box-shadow:0 10px 35px rgba(0,0,0,0.18);
        }

        .popup-card h3 {
            margin-top:0;
            margin-bottom:18px;
        }

        .popup-card label {
            font-size:13px;
            font-weight:600;
            margin-bottom:5px;
            display:block;
        }

        .popup-input {
            width:100%;
            padding:10px 12px;
            border-radius:8px;
            border:1px solid #ccc;
            margin-bottom:12px;
            font-size:14px;
        }

        .popup-actions {
            margin-top:10px;
            text-align:right;
        }

        .popup-btn {
            padding:8px 16px;
            border-radius:6px;
            border:none;
            font-weight:600;
            cursor:pointer;
            margin-left:8px;
        }

        .popup-btn.save {
            background:#1e9b48;
            color:white;
        }

        .popup-btn.cancel {
            background:#777;
            color:white;
        }
    </style>
</head>
<body>

{% include "SuperAdmin/superAdmin_header_sidebar.html" %}

<div class="content-wrapper">

    <h1 class="page-title">Batches</h1>

    <!-- Filters -->
    <div class="filters-row">
        <select id="deptFilter" class="select-input">
            <option value="">Select Department</option>
            {% for d in departments %}
                <option value="{{ d.dept_id }}">{{ d.name }}</option>
            {% endfor %}
        </select>

        <select id="courseFilter" class="select-input">
            <option value="">Select Course</option>
            {% for c in courses %}
                <option value="{{ c.course_id }}" data-dept="{{ c.department.dept_id }}">
                    {{ c.course_name }}
                </option>
            {% endfor %}
        </select>

        <button id="btnAddBatch" class="primary-btn">
            + Add Batch
        </button>
    </div>

    <!-- Batches table -->
    <div class="table-card">
        <table>
            <thead>
            <tr>
                <th style="width:40%">Batch Name</th>
                <th style="width:40%">Course</th>
                <th style="width:20%">Actions</th>
            </tr>
            </thead>
            <tbody id="batchTableBody">
            {% for b in batches %}
                <tr data-dept="{{ b.course.department.dept_id }}" data-course="{{ b.course.course_id }}">
                    <td>{{ b.batch_name }}</td>
                    <td>{{ b.course.course_name }}</td>
                    <td>
                        <!-- (Edit wiring can be added later if you want) -->
                        <a href="{% url 'superAdmin_delete_batch' b.batch_id %}"
                           class="action-link action-delete">Delete</a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="3">No batches yet.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Popup Add Batch -->
<div id="batchPopup" class="popup-overlay">
    <div class="popup-card">
        <h3>Add Batch</h3>
        <form id="batchForm" method="post" action="{% url 'superAdmin_add_batch' %}">
            {% csrf_token %}
            <label for="batchName">Batch Name</label>
            <input type="text" id="batchName" name="batch_name" class="popup-input" required>

            <label for="batchCourse">Course</label>
            <select id="batchCourse" name="course_id" class="popup-input" required>
                <option value="">Select Course</option>
                {% for c in courses %}
                    <option value="{{ c.course_id }}" data-dept="{{ c.department.dept_id }}">
                        {{ c.course_name }}
                    </option>
                {% endfor %}
            </select>

            <div class="popup-actions">
                <button type="button" class="popup-btn cancel" onclick="closeBatchPopup()">Cancel</button>
                <button type="submit" class="popup-btn save">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
    const deptFilter     = document.getElementById('deptFilter');
    const courseFilter   = document.getElementById('courseFilter');
    const batchRows      = document.querySelectorAll('#batchTableBody tr');

    const batchPopup     = document.getElementById('batchPopup');
    const batchForm      = document.getElementById('batchForm');
    const batchCourseSel = document.getElementById('batchCourse');
    const btnAddBatch    = document.getElementById('btnAddBatch');

    // Filter courses in both dropdowns when department changes
    function filterCoursesByDept() {
        const deptId = deptFilter.value;

        [courseFilter, batchCourseSel].forEach(select => {
            const options = select.querySelectorAll('option');

            options.forEach((opt, index) => {
                if (index === 0) {          // "Select Course"
                    opt.hidden = false;
                    return;
                }
                const optDept = opt.dataset.dept;
                if (!deptId || optDept === deptId) {
                    opt.hidden = false;
                } else {
                    opt.hidden = true;
                }
            });

            // reset selected course
            select.value = '';
        });

        filterBatchRows();
    }

    function filterBatchRows() {
        const deptId   = deptFilter.value;
        const courseId = courseFilter.value;

        batchRows.forEach(row => {
            const rowDept   = row.dataset.dept;
            const rowCourse = row.dataset.course;

            let visible = true;
            if (deptId && rowDept !== deptId) visible = false;
            if (courseId && rowCourse !== courseId) visible = false;

            row.style.display = visible ? 'table-row' : 'none';
        });
    }

    deptFilter.addEventListener('change', filterCoursesByDept);
    courseFilter.addEventListener('change', filterBatchRows);

    // ----- Popup handling -----
    function openBatchPopup() {
        // reset form
        batchForm.reset();

        // pre-select course based on current filter
        const selectedCourse = courseFilter.value;
        if (selectedCourse) {
            batchCourseSel.value = selectedCourse;
        }

        batchPopup.classList.add('show');
    }

    function closeBatchPopup() {
        batchPopup.classList.remove('show');
    }

    btnAddBatch.addEventListener('click', openBatchPopup);

    // Close popup if user clicks outside the card
    batchPopup.addEventListener('click', function (e) {
        if (e.target === batchPopup) {
            closeBatchPopup();
        }
    });
</script>

</body>
</html>
